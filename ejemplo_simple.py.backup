"""
EJEMPLO SIMPLE Y R√ÅPIDO
Estrategia NY Range Breakout para XAUUSD

Este archivo contiene un ejemplo minimalista para comenzar r√°pidamente.
Para uso completo, ver: run_ny_range_backtest.py y GUIA_NY_RANGE_BREAKOUT.md
"""

from datetime import datetime, timedelta
import pandas as pd
import numpy as np
from strategies.ny_range_breakout_strategy import NYRangeBreakout

# ============================================================================
# PASO 1: GENERAR DATOS DE MUESTRA
# ============================================================================

def generar_datos_xauusd(dias=365):
    """Genera datos sint√©ticos de XAUUSD para pruebas"""
    print(f"üìä Generando {dias} d√≠as de datos XAUUSD...")
    
    # Crear timestamps (barras de 5 minutos)
    fechas = pd.date_range(
        end=datetime.now(),
        periods=dias * 288,  # 288 barras de 5 min por d√≠a
        freq='5min'
    )
    
    # Simular precios realistas
    np.random.seed(42)
    precio_inicial = 2000.0
    precios = precio_inicial + np.cumsum(np.random.normal(0.05, 2.0, len(fechas)))
    
    # Crear DataFrame OHLC
    data = pd.DataFrame({
        'open': precios,
        'high': precios * 1.002,
        'low': precios * 0.998,
        'close': precios * (1 + np.random.normal(0, 0.001, len(fechas))),
        'tick_volume': np.random.randint(100, 1000, len(fechas)),
        'spread': 20,
        'real_volume': np.random.randint(1000, 10000, len(fechas))
    }, index=fechas)
    
    # Ajustar high/low
    data['high'] = data[['open', 'high', 'close']].max(axis=1)
    data['low'] = data[['open', 'low', 'close']].min(axis=1)
    
    print(f"‚úÖ Datos generados: {len(data)} barras")
    return data


# ============================================================================
# PASO 2: CREAR Y CONFIGURAR ESTRATEGIA
# ============================================================================

print("\n" + "="*70)
print("üéØ NY RANGE BREAKOUT - EJEMPLO SIMPLE")
print("="*70)

# Crear estrategia con par√°metros por defecto
estrategia = NYRangeBreakout(
    range_start_hour=21,        # 21:50 hora NY
    range_start_minute=50,
    range_end_hour=22,          # 22:15 hora NY
    range_end_minute=15,
    stop_loss_pips=34.0,        # 34 pips SL
    take_profit_pips=83.0,      # 83 pips TP
    min_range_pips=5.0,         # Rango m√≠nimo 5 pips
    max_trades_per_day=1        # M√°ximo 1 trade por d√≠a
)

print("\n‚úÖ Estrategia creada:")
print(f"   Horario: 21:50 - 22:15 NY")
print(f"   SL: {estrategia.parameters['stop_loss_pips']} pips")
print(f"   TP: {estrategia.parameters['take_profit_pips']} pips")


# ============================================================================
# PASO 3: CARGAR DATOS
# ============================================================================

# Opci√≥n A: Usar datos de muestra (recomendado para empezar)
datos = generar_datos_xauusd(dias=180)  # 6 meses

# Opci√≥n B: Usar datos reales de MT5 (descomentar si tienes MT5)
"""
from data_manager import MT5DataManager
from config.settings import MT5Config

data_manager = MT5DataManager(MT5Config())
data_manager.connect()
datos = data_manager.get_historical_data(
    symbol="XAUUSD",
    timeframe="M5",
    start_date=datetime.now() - timedelta(days=180),
    count=50000
)
data_manager.disconnect()
"""


# ============================================================================
# PASO 4: EJECUTAR ESTRATEGIA (Calcular Indicadores y Se√±ales)
# ============================================================================

print("\n‚öôÔ∏è Ejecutando estrategia...")

# Calcular indicadores
datos_con_indicadores = estrategia.calculate_indicators(datos)

# Generar se√±ales
se√±ales = estrategia.generate_signals(datos_con_indicadores)

print(f"\n‚úÖ Estrategia ejecutada:")
print(f"   Se√±ales generadas: {len(se√±ales)}")


# ============================================================================
# PASO 5: ANALIZAR SE√ëALES
# ============================================================================

print("\nüìä AN√ÅLISIS DE SE√ëALES:")
print("="*70)

if len(se√±ales) > 0:
    # Contar se√±ales por tipo
    compras = sum(1 for s in se√±ales if s.signal_type == 'BUY')
    ventas = sum(1 for s in se√±ales if s.signal_type == 'SELL')
    
    print(f"\nüìà Se√±ales de COMPRA: {compras}")
    print(f"üìâ Se√±ales de VENTA: {ventas}")
    print(f"üìä Total de se√±ales: {len(se√±ales)}")
    
    # Mostrar primeras 5 se√±ales
    print("\nüîç Primeras 5 se√±ales:")
    print("-" * 70)
    
    for i, se√±al in enumerate(se√±ales[:5]):
        print(f"\n{i+1}. {se√±al.signal_type}")
        print(f"   Fecha: {se√±al.timestamp}")
        print(f"   Precio: {se√±al.price:.2f}")
        print(f"   Stop Loss: {se√±al.stop_loss:.2f}")
        print(f"   Take Profit: {se√±al.take_profit:.2f}")
        
        # Calcular R:R
        if se√±al.signal_type == 'BUY':
            riesgo = se√±al.price - se√±al.stop_loss
            recompensa = se√±al.take_profit - se√±al.price
        else:  # SELL
            riesgo = se√±al.stop_loss - se√±al.price
            recompensa = se√±al.price - se√±al.take_profit
        
        rr_ratio = recompensa / riesgo if riesgo > 0 else 0
        print(f"   Risk:Reward: 1:{rr_ratio:.2f}")
        print(f"   Rango: {se√±al.metadata.get('range_pips', 0):.1f} pips")
        print(f"   Tipo: {se√±al.metadata.get('breakout_type', 'N/A')}")
    
    # Estad√≠sticas de rangos
    rangos = [s.metadata.get('range_pips', 0) for s in se√±ales]
    print(f"\nüìä ESTAD√çSTICAS DE RANGOS:")
    print(f"   Rango promedio: {np.mean(rangos):.2f} pips")
    print(f"   Rango m√≠nimo: {np.min(rangos):.2f} pips")
    print(f"   Rango m√°ximo: {np.max(rangos):.2f} pips")
    print(f"   Desviaci√≥n est√°ndar: {np.std(rangos):.2f} pips")
    
else:
    print("‚ö†Ô∏è No se generaron se√±ales")
    print("   Posibles razones:")
    print("   - Periodo muy corto")
    print("   - Rangos muy peque√±os (< min_range_pips)")
    print("   - Datos fuera del horario NY")


# ============================================================================
# PASO 6: EJECUTAR BACKTEST COMPLETO (OPCIONAL)
# ============================================================================

print("\n" + "="*70)
print("üí° SIGUIENTE PASO: BACKTEST COMPLETO")
print("="*70)

print("""
Para un backtest completo con:
- Simulaci√≥n realista de trades
- C√°lculo de m√©tricas (Sharpe, Drawdown, etc.)
- Reportes HTML con gr√°ficos
- An√°lisis de rendimiento

Ejecuta:
    python run_ny_range_backtest.py

O usa el BacktestEngine:
""")

print("""
from backtest_engine import BacktestEngine
from config.settings import BacktestConfig

config = BacktestConfig(
    initial_capital=10000.0,
    commission_pct=0.0001,
    slippage_pct=0.0005
)

symbol_info = {
    'point': 0.01,
    'digits': 2,
    'trade_contract_size': 100.0
}

engine = BacktestEngine(config)
resultado = engine.run(estrategia, datos, symbol_info)

print(resultado.summary())
""")


# ============================================================================
# PASO 7: OPTIMIZACI√ìN ML (OPCIONAL)
# ============================================================================

print("\n" + "="*70)
print("ü§ñ OPTIMIZACI√ìN CON MACHINE LEARNING")
print("="*70)

print("""
Para encontrar los mejores par√°metros autom√°ticamente:

    python run_ny_range_backtest.py
    # Selecciona opci√≥n: 3

O directamente:
""")

print("""
from ml_optimizer import MLStrategyOptimizer

optimizer = MLStrategyOptimizer(
    strategy_class=NYRangeBreakout,
    data=datos,
    symbol_info=symbol_info,
    target_metric='sharpe_ratio',
    n_iterations=50
)

resultado_opt = optimizer.bayesian_optimization()
print(resultado_opt.best_params)
""")


# ============================================================================
# RESUMEN FINAL
# ============================================================================

print("\n" + "="*70)
print("‚úÖ EJEMPLO COMPLETADO")
print("="*70)

print(f"""
üìä Resumen:
   - Datos procesados: {len(datos)} barras
   - Se√±ales generadas: {len(se√±ales)}
   - Per√≠odo analizado: {datos.index[0]} a {datos.index[-1]}

üìö Pr√≥ximos pasos:
   1. Revisar GUIA_NY_RANGE_BREAKOUT.md para gu√≠a completa
   2. Ejecutar run_ny_range_backtest.py para backtest completo
   3. Probar optimizaci√≥n ML (opci√≥n 3)
   4. Experimentar con diferentes par√°metros

‚ö†Ô∏è Recuerda: Este es un sistema de backtesting educacional.
   Prueba extensivamente antes de usar en trading real.

üöÄ ¬°Feliz backtesting!
""")